<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrix Tools</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
    <style>
        body {
            font-family: 'Helvetica', sans-serif;
            background-color: #1c1c1c;
            color: #ffffff;
        }
        .btn {
            background-color: #333333;
            color: #ffffff; /* White text */
            font-weight: bold;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            border: 2px solid #555555;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .btn:hover {
            background-color: #555555;
        }
        .input-dark {
            background-color: #2b2b2b;
            color: #ffffff;
            border: 1px solid #444444;
        }
        .input-dark::placeholder {
            color: #888888;
        }
        .input-dark:focus {
            outline: none;
            border-color: #6a6a6a;
        }
        .hidden {
            display: none;
        }
        /* New styles for matrix display */
        .matrix-container {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 0 1em;
            margin: 0.5em 0;
        }
        .matrix-container::before,
        .matrix-container::after {
            content: "";
            position: absolute;
            top: 0;
            bottom: 0;
            width: 10px;
            border-color: #ffffff;
            border-style: solid;
        }
        .matrix-container::before {
            left: 0;
            border-width: 3px 0 3px 3px;
            border-radius: 10px 0 0 10px;
        }
        .matrix-container::after {
            right: 0;
            border-width: 3px 3px 3px 0;
            border-radius: 0 10px 10px 0;
        }
        .matrix-table {
            border-collapse: collapse;
            margin: 0 0.5em;
        }
        .matrix-table td {
            padding: 0.5em 1em;
            text-align: center;
            font-size: 1.25rem;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-4xl mx-auto p-4 md:p-8">

        <!-- Start Menu -->
        <div id="start-menu" class="text-center">
            <h1 class="text-5xl md:text-6xl font-bold mb-12">Matrix Tools</h1>
            <div class="space-y-6">
                <button id="show-calculator-btn" class="btn text-xl w-full md:w-96">Eigenvalue Calculator</button>
                <button id="show-generator-btn" class="btn text-xl w-full md:w-96">Matrix Generator</button>
                <button id="show-practice-btn" class="btn text-xl w-full md:w-96">Random Practice Problem</button>
            </div>
        </div>

        <!-- Eigenvalue Calculator -->
        <div id="calculator-view" class="hidden">
            <button class="btn mb-8" onclick="showView('start-menu')">← Back to Menu</button>
            <h2 class="text-4xl font-bold text-center mb-8">Eigenvalue Calculator</h2>
            
            <div class="flex items-center space-x-4 mb-6">
                <label for="matrix-size" class="text-lg">Matrix Size (N x N):</label>
                <input type="number" id="matrix-size" min="1" max="10" value="2" class="input-dark w-20 p-2 rounded-md text-center">
            </div>

            <div id="matrix-input-grid" class="grid grid-cols-2 gap-4 mb-6" style="grid-template-columns: repeat(2, minmax(0, 1fr));">
                <!-- Matrix input cells will be generated here by JS -->
            </div>

            <div class="text-center">
                <button id="calculate-btn" class="btn text-lg">Calculate</button>
            </div>

            <div class="mt-8">
                <h3 class="text-2xl font-bold mb-4">Results:</h3>
                <div id="calculator-results" class="text-lg"></div>
            </div>
        </div>

        <!-- Matrix Generator -->
        <div id="generator-view" class="hidden">
            <button class="btn mb-8" onclick="showView('start-menu')">← Back to Menu</button>
            <h2 class="text-4xl font-bold text-center mb-8">Matrix Generator</h2>
            
            <div class="mb-6">
                <label for="eigenvalues-input" class="block text-lg mb-2">Eigenvalues (comma-separated):</label>
                <input type="text" id="eigenvalues-input" class="input-dark w-full p-3 rounded-md" placeholder="e.g., 5, -1">
            </div>

            <div class="mb-6">
                <label for="eigenvectors-input" class="block text-lg mb-2">Eigenvectors (Optional - enter as columns):</label>
                <textarea id="eigenvectors-input" rows="6" class="input-dark w-full p-3 rounded-md" placeholder="Example for a 2x2 matrix:&#10;1 0.5&#10;0.5 1"></textarea>
            </div>

            <div class="text-center">
                <button id="generate-btn" class="btn text-lg">Generate Matrix</button>
            </div>

            <div class="mt-8">
                <h3 id="generator-title" class="text-2xl font-bold mb-4">Generated Matrix:</h3>
                <div id="generator-results"></div>
            </div>
        </div>
        
        <!-- Random Practice Problem -->
        <div id="practice-view" class="hidden">
            <button class="btn mb-8" onclick="showView('start-menu')">← Back to Menu</button>
            <h2 class="text-4xl font-bold text-center mb-8">Random Practice Problem</h2>
            
            <div class="flex items-center space-x-4 mb-6 justify-center">
                <label for="practice-size" class="text-lg">Matrix Size (N x N):</label>
                <input type="number" id="practice-size" min="2" max="8" value="3" class="input-dark w-20 p-2 rounded-md text-center">
            </div>

            <div class="text-center">
                <button id="generate-practice-btn" class="btn text-lg">Generate Problem</button>
            </div>

            <div id="practice-results" class="mt-8 text-lg"></div>
        </div>

    </div>

    <script>
        // --- Helper function for formatting ---
        function formatMatrixForDisplay(matrix) {
            const array = typeof matrix.toArray === 'function' ? matrix.toArray() : matrix;
            
            let tableHTML = '<table class="matrix-table">';
            if (!Array.isArray(array[0])) { // It's a vector
                tableHTML += '<tr>';
                array.forEach(val => {
                    tableHTML += `<td>${math.format(val, { precision: 4 })}</td>`;
                });
                tableHTML += '</tr>';
            } else { // It's a 2D matrix
                array.forEach(row => {
                    tableHTML += '<tr>';
                    row.forEach(val => {
                        tableHTML += `<td>${math.format(val, { precision: 4 })}</td>`;
                    });
                    tableHTML += '</tr>';
                });
            }
            tableHTML += '</table>';
            return `<div class="matrix-container">${tableHTML}</div>`;
        }

        // --- Navigation ---
        const views = ['start-menu', 'calculator-view', 'generator-view', 'practice-view'];
        function showView(viewId) {
            views.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
        }

        document.getElementById('show-calculator-btn').addEventListener('click', () => showView('calculator-view'));
        document.getElementById('show-generator-btn').addEventListener('click', () => showView('generator-view'));
        document.getElementById('show-practice-btn').addEventListener('click', () => showView('practice-view'));

        // --- Eigenvalue Calculator Logic ---
        const matrixSizeInput = document.getElementById('matrix-size');
        const matrixGrid = document.getElementById('matrix-input-grid');
        const calculateBtn = document.getElementById('calculate-btn');
        const calculatorResults = document.getElementById('calculator-results');

        function createMatrixGrid() {
            const size = parseInt(matrixSizeInput.value) || 2;
            matrixGrid.innerHTML = '';
            matrixGrid.style.gridTemplateColumns = `repeat(${size}, minmax(0, 1fr))`;
            for (let i = 0; i < size * size; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'input-dark p-2 w-full text-center rounded-md text-lg';
                matrixGrid.appendChild(input);
            }
        }

        matrixSizeInput.addEventListener('input', createMatrixGrid);

        calculateBtn.addEventListener('click', () => {
            const size = parseInt(matrixSizeInput.value);
            const inputs = matrixGrid.getElementsByTagName('input');
            const matrixData = [];
            
            try {
                let row = [];
                for (let i = 0; i < inputs.length; i++) {
                    const val = inputs[i].value.trim();
                    if (val === '') {
                        alert('Please fill all matrix cells.');
                        return;
                    }
                    row.push(parseFloat(val));
                    if ((i + 1) % size === 0) {
                        matrixData.push(row);
                        row = [];
                    }
                }
                
                const matrix = math.matrix(matrixData);
                const result = math.eigs(matrix);

                const eigenvalues = result.values.toArray();
                const eigenvectorsMatrix = result.vectors;
                const vectorSize = eigenvectorsMatrix.size()[0];
                const numVectors = eigenvectorsMatrix.size()[1];
                
                let resultsHTML = '<h3 class="text-2xl font-bold mb-4">Eigenvalues and Eigenvectors:</h3>';
                resultsHTML += '<div class="flex flex-wrap justify-center gap-8">';

                const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
                const lcm = (a, b) => Math.abs(a * b) / gcd(a, b);

                for (let j = 0; j < numVectors; j++) {
                    const vector = eigenvectorsMatrix.subset(math.index(math.range(0, vectorSize), j));
                    const vectorArray = vector.toArray().flat();
                    
                    let finalVectorForDisplay;

                    // --- NEW CONDITIONAL INTEGER SCALING LOGIC ---
                    let firstNonZero = vectorArray.find(v => math.abs(v) > 1e-9) || 1;
                    const normalizedVector = vectorArray.map(v => v / firstNonZero);
                    
                    let fractions;
                    try {
                        fractions = normalizedVector.map(v => math.fraction(v));
                    } catch (e) {
                        fractions = null; // Cannot be represented as clean fractions
                    }

                    const MAX_DENOMINATOR = 10000; // Avoid huge numbers from floating point errors
                    if (fractions && fractions.every(f => f.d < MAX_DENOMINATOR)) {
                        const denominators = fractions.map(f => f.d);
                        const commonMultiple = denominators.reduce(lcm, 1);
                        const potentialIntegerVector = normalizedVector.map(v => v * commonMultiple);
                        
                        // Check if all elements are very close to integers
                        const isIntegerVector = potentialIntegerVector.every(v => math.abs(v - math.round(v)) < 1e-9);

                        if (isIntegerVector) {
                            finalVectorForDisplay = math.matrix(potentialIntegerVector.map(v => [math.round(v)]));
                        }
                    }
                    
                    // If integer scaling failed or wasn't possible, use the fallback
                    if (!finalVectorForDisplay) {
                        let maxAbsVal = 0;
                        let divisor = 1;
                        for (const val of vectorArray) {
                            if (math.abs(val) > maxAbsVal) {
                                maxAbsVal = math.abs(val);
                                divisor = val;
                            }
                        }
                        if (math.abs(divisor) < 1e-9) divisor = 1;
                        finalVectorForDisplay = vector.map(val => [val / divisor]);
                    }
                    // --- END OF NEW LOGIC ---

                    const vectorHTML = formatMatrixForDisplay(finalVectorForDisplay);
                    
                    resultsHTML += `
                        <div class="text-center">
                            <p class="mb-2">&lambda;<sub>${j + 1}</sub> = ${math.format(eigenvalues[j], { precision: 4 })}</p>
                            <div class="flex items-center justify-center">
                                <p class="mr-2">x<sub>${j + 1}</sub> = </p>
                                ${vectorHTML}
                            </div>
                        </div>
                    `;
                }
                resultsHTML += '</div>';
                calculatorResults.innerHTML = resultsHTML;

            } catch (error) {
                calculatorResults.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
            }
        });
        
        // --- Matrix Generator Logic ---
        const eigenvaluesInput = document.getElementById('eigenvalues-input');
        const eigenvectorsInput = document.getElementById('eigenvectors-input');
        const generateBtn = document.getElementById('generate-btn');
        const generatorResults = document.getElementById('generator-results');
        const generatorTitle = document.getElementById('generator-title');

        generateBtn.addEventListener('click', () => {
            try {
                const eigenvalStr = eigenvaluesInput.value.trim();
                if (!eigenvalStr) throw new Error("Eigenvalues input is empty.");
                const eigenvalues = eigenvalStr.split(',').map(v => {
                    const num = parseFloat(v.trim());
                    if (isNaN(num)) throw new Error("Invalid number in eigenvalues.");
                    return num;
                });
                const n = eigenvalues.length;

                const evecStr = eigenvectorsInput.value.trim();
                let generatedMatrix;

                const rows = evecStr.split('\n')
                    .map(line => line.trim())
                    .filter(line => line && !line.toLowerCase().includes('example'))
                    .map(line => {
                        const stringValues = line.replace(/,/g, ' ').split(/\s+/).filter(s => s.length > 0);
                        return stringValues.map(numStr => {
                            const num = parseFloat(numStr);
                            if (isNaN(num)) throw new Error(`Invalid non-numeric value "${numStr}" found in eigenvectors.`);
                            return num;
                        });
                    })
                    .filter(row => row.length > 0);

                if (evecStr && rows.length > 0) {
                    if (rows.length !== n) {
                        throw new Error(`Dimension Mismatch: You entered ${n} eigenvalues, but provided ${rows.length} rows for the eigenvector matrix.`);
                    }
                    for(const row of rows) {
                        if (row.length !== n) {
                             throw new Error(`Dimension Mismatch: The eigenvector matrix must be square. One of your rows does not have ${n} columns.`);
                        }
                    }

                    generatorTitle.textContent = "Generated Matrix (A = PDP⁻¹):";
                    const P = math.transpose(math.matrix(rows));
                    const D = math.diag(eigenvalues);
                    const P_inv = math.inv(P);
                    generatedMatrix = math.multiply(P, D, P_inv);
                } else {
                    generatorTitle.textContent = "Generated Diagonal Matrix:";
                    generatedMatrix = math.diag(eigenvalues);
                }
                generatorResults.innerHTML = formatMatrixForDisplay(generatedMatrix);
            } catch (error) {
                generatorResults.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
            }
        });

        // --- Random Practice Problem Logic ---
        const practiceSizeInput = document.getElementById('practice-size');
        const generatePracticeBtn = document.getElementById('generate-practice-btn');
        const practiceResults = document.getElementById('practice-results');

        generatePracticeBtn.addEventListener('click', () => {
            try {
                const size = parseInt(practiceSizeInput.value);
                if (isNaN(size) || size < 2) {
                    throw new Error("Please select a valid matrix size of 2 or greater.");
                }

                let lambdas = [];
                while(lambdas.length < size) {
                    let randInt = math.floor(math.random() * 11) - 5;
                    if (!lambdas.includes(randInt)) {
                        lambdas.push(randInt);
                    }
                }
                
                let pArray = [];
                for (let i = 0; i < size; i++) {
                    let row = [];
                    for (let j = 0; j < size; j++) {
                        if (i === j) row.push(1);
                        else if (j > i) row.push(math.floor(math.random() * 5) - 2);
                        else row.push(0);
                    }
                    pArray.push(row);
                }
                const P_int = math.matrix(pArray);

                const D = math.diag(lambdas);
                const P_inv = math.inv(P_int);
                const problemMatrix = math.multiply(P_int, D, P_inv);
                
                const solutionEigenvalues = lambdas;
                const solutionEigenvectors = P_int;

                const matrixHTML = formatMatrixForDisplay(problemMatrix);
                
                let solutionHTML = '<div class="flex flex-wrap justify-center gap-8">';
                const eigenvectorsArray = solutionEigenvectors.toArray();

                for (let j = 0; j < size; j++) {
                    const columnVector = eigenvectorsArray.map(row => [row[j]]);
                    const vectorHTML = formatMatrixForDisplay(columnVector);
                    solutionHTML += `
                        <div class="text-center">
                            <p class="mb-2">&lambda;<sub>${j + 1}</sub> = ${math.format(solutionEigenvalues[j], { precision: 4 })}</p>
                            <div class="flex items-center justify-center">
                                <p class="mr-2">x<sub>${j + 1}</sub> = </p>
                                ${vectorHTML}
                            </div>
                        </div>
                    `;
                }
                solutionHTML += '</div>';

                practiceResults.innerHTML = `
                    <h3 class="text-2xl font-bold mb-4">Generated Matrix:</h3>
                    <div class="flex justify-center">${matrixHTML}</div>
                    <h3 class="text-2xl font-bold mt-6 mb-4">Solution:</h3>
                    ${solutionHTML}
                `;

            } catch (error) {
                practiceResults.innerHTML = `<p class="text-red-400 text-center">Error: ${error.message}</p>`;
            }
        });

        // --- Initial Setup ---
        createMatrixGrid();
    </script>

</body>
</html>
